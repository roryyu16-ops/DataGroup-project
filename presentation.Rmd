---
title: "Heart Disease Mortality in the Scotland"
author: "Artery Party <br> Roderick Yu, Yufei Xiang, Hoddy Zhu, Lincoln Luk"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

```{r install-package, include = FALSE, eval = FALSE}
# Copy and paste the following code into your console to download and install
# the `xaringan` package that contains all of the code which allows you 
# to create presentation slides in Rmarkdown
install.packages('xaringan')
```


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
# load your data 
MArea <- read_csv("data/HDM_CouncilArea.csv")
Data<- MArea %>%
  select(Year,CA,AgeGroup,Sex,Diagnosis,CrudeRate,EASR) %>%
  drop_na()

```



```{r include=FALSE}

#Background image
style_xaringan(
  title_slide_background_image = "img/heartimages.jpg"
)
```



class: inverse, center, middle

# Research Question

---

class: center, middle

# Research Question

<span style="font-size: 1.4em; font-weight: bold;"> How do heart disease mortality rates vary across Scotland, and which factors are more important? </span>

# Aim

<span style="font-size: 1.4em; font-weight: bold;"> to use predictive modelling to provide risk predictions for the Scottish population </span>


---

class: inverse, center, middle

# How do we clean the data?

---
# How do we clean the data?

.pull-left[

- Select key variables. 
- Remove NA values.

```{r echo = FALSE, warning=FALSE, message=FALSE}

Data[ , 3:5]

```


]

.pull-right[
<span style="font-size: 1.4em; font-weight: bold;"> Data Overview: </span>
```{r echo = FALSE, warning=FALSE, message=FALSE}

library(kableExtra)

overview <- tribble(
  ~Variable,       ~Description,                                  ~Type,
  "Year",          "Year of recorded data",                       "Numeric",
  "CA",            "Council area code",                           "Categorical",
  "AgeGroup",      "Defined age range",                           "Categorical",
  "Sex",           "Male or female",                              "Categorical",
  "Diagnosis",     "Specific heart-disease-related diagnosis",    "Categorical",
  "CrudeRate",     "Raw mortality rate",                          "Numeric",
  "EASR",          "European Age-Standardised Rate",              "Numeric"
)

overview %>%
  kable(head(overview), format = ("html")) %>% 
  kable_styling(full_width = FALSE, position = "left")
```
]


---
class: inverse, center, middle

<style>
.my-style .pull-left { 
  float: left;
  width: 15%;
  margin-left: 35%;
}

.my-style .pull-right {
  float: right;
  width: 15%;
  margin-right: 35%;
}
</style>


# Crude Mortality by Six Factors


<div class="my-style">
.pull-left[
- EASR  
- Gender  
- Age Group  
]

.pull-right[
<p style="margin: 0; padding: 0; text-align: left;">
- Diagnosis
- Year
- Region  
]
</div>

---

# EASR

```{r out.width= "75%", fig.align="center", echo = FALSE, warning=FALSE, message=FALSE}

ggplot(data = Data,
       mapping = aes(x = EASR, 
                     y = CrudeRate, 
                     )) +
  geom_point(size = 1)+
  geom_smooth(method = lm , se = FALSE)+
  labs(title = "EASR with CrudeRate",
       x="EASR",
       y=" CrudeRate",
       fill="Sex") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )

```


---

# Gender

```{r out.width= "75%", fig.align="center", echo = FALSE}
# Bar chart of Sex
table_sex<-Data %>% 
  filter(!Sex %in% c("All"))%>%
  group_by(Sex) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(table_sex)+
       geom_bar(mapping= aes (x=Sex,
                     y=mean_cruderate,
                     fill=Sex),
                     stat = "identity")+
  labs(title = "The mean value of cruderate for different Sexs",
       x="Sex",
       y="Mean Cruderate",
       fill="Sex")
```


---

# Age Group

```{r out.width= "75%", fig.align="center",fig.width=7, echo = FALSE, warning=FALSE}
#Bar chart of Age Group
table_age<-Data %>%
  filter(!AgeGroup %in% c("All"))%>%
  group_by(AgeGroup) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(table_age)+
       geom_bar(mapping= aes (x=AgeGroup,
                              y=mean_cruderate,
                              fill=AgeGroup),
                              stat = "identity")+
  labs(title = "The mean value of cruderate for different AgeGroups",
       x="Age",
       y="Mean Cruderate",
       fill="AgeGroup")
```



---

# Diagnosis

```{r out.width= "75%", fig.align="center",fig.width=7, echo = FALSE, warning=FALSE, message=FALSE}
table_Diagnosis<-Data %>%
  group_by(Diagnosis) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(table_Diagnosis)+
       geom_bar(mapping= aes (x=Diagnosis,
                     y=mean_cruderate,
                     fill=Diagnosis),
                     stat = "identity")+
  labs(title = "The mean value of cruderate for different Diagnosis",
       x="Diagnosis",
       y="Mean Cruderate",
       fill="Diagnosis")
```


---

# Year

```{r out.width= "75%", fig.align="center",fig.width=7, echo = FALSE, warning=FALSE, message=FALSE}
summary_diagnosis <- Data%>%
  group_by(Year) %>%
   summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(summary_diagnosis, aes(x = Year, y = mean_cruderate)) +
  geom_line(size = 1) +
  geom_point() +
  labs(
    title = "The mean value of cruderate over Years",
    x = "Year",
    y = "Mean Cruderate"
  ) +
  theme_minimal()
```




---

# Regions

```{r echo = FALSE}
CA_Regions <- Data %>% 
  filter(!CA %in% c("S92000003")) %>%
  mutate(
    Region = case_when(
      CA %in% c("S12000033", "S12000034", "S12000020", "S12000017") ~ "North",
      CA %in% c("S12000038", "S12000039", "S12000015","S12000047") ~ "North East",
      CA %in% c("S12000005", "S12000014", "S12000026", "S12000036", "S12000042", "S12000044","S12000048") ~ "Central",
      CA %in% c("S12000006", "S12000010", "S12000019", "S12000028", "S12000045") ~ "South",
      CA %in% c("S12000008", "S12000009", "S12000011", "S12000018", "S12000021", "S12000023", "S12000027", "S12000030", "S12000035", "S12000040", "S12000041","S12000013","S12000029","S12000049","S12000050") ~ "West",
      TRUE ~ "Others"
      )
  )


CA_summary <- CA_Regions %>%
  group_by(Region) %>%
  summarise(
    mean_rate  = mean(CrudeRate, na.rm = TRUE)
  )
```

```{r out.width= "75%", fig.align="center", echo = FALSE}
  ggplot(CA_summary, aes(x = Region, y = mean_rate)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Crude Mortality Rate by Council Area",
    x = "Region",
    y = "Mean Crude Mortality Rate"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
  )
```


---

class: inverse, center, middle

# Crude Mortality by Chart of two variables

---
class: center, middle

.pull-left[

<span style="font-size: 1.4em; font-weight: bold;"> Agegroup and Diagnosis </span>

```{r out.width= "130%", fig.align="center", echo = FALSE, message=FALSE, warning=FALSE}
table_1<- Data %>%
  filter(!AgeGroup %in% c("All"))%>%
  group_by(AgeGroup,Diagnosis) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(table_1, aes(x = Diagnosis, y = mean_cruderate, fill = AgeGroup)) +
  geom_col(position = position_dodge(width = 0.8)) +
  labs(
    title = "Mean crude rate by heart-disease type and Agegroup",
    x = "Heart-disease type",
    y = "Mean crude rate",
    fill = "AgeGroup"
  )+
  theme(
    plot.margin = unit(c(0, 0, 0, 0), "cm"), 
  )
```
]


.pull-right[


<span style="font-size: 1.4em; font-weight: bold;"> Sex and Diagnosis </span>

```{r out.width= "130%", fig.align="center", echo = FALSE, message=FALSE}
Table_2<-Data %>%
  filter(!Sex %in% c("All"))%>%
  group_by(Sex,Diagnosis) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))
ggplot(Table_2, aes(x = Diagnosis, y = mean_cruderate, fill = Sex)) +
  geom_col(position = position_dodge(width = 0.8)) +
  labs(
    title = "Mean crude rate by heart-disease type and sex",
    x = "Heart-disease type",
    y = "Mean crude rate",
    fill = "Sex"
  )+
  theme(
    plot.margin = unit(c(0, 0, 0, 0), "cm"), 
  )
```
]
---


class: inverse, center, middle

# Model building

---

class: inverse, center, middle

# Linear regression model

---

# Set up

--
```{r out.width= "75%", fig.align="center", echo = FALSE}

Data<-Data%>%
  filter(!Sex %in% c("All"))%>% 
  filter(!AgeGroup %in% c("All"))
  
Data <- Data %>%
  mutate(
    split_AgeGroup = case_when(
      AgeGroup %in% c("75plus years") ~ "75plus years",
      AgeGroup %in% c("0-44 years", "45-64 years", "65-74 years", "under75 years") ~ "under75 years",
      TRUE ~ "Others"
      )
  )

Data$split_AgeGroup<-relevel(factor(Data$split_AgeGroup),ref="under75 years")
Data$Diagnosis<-relevel(factor(Data$Diagnosis),ref="Heart Failure")
Data$Sex<-relevel(factor(Data$Sex),ref="Females")


ht_yc_fit_1 <- linear_reg() %>%
  set_engine("lm") %>%
  fit(CrudeRate ~ Year+split_AgeGroup+Sex+Diagnosis ,data = Data)
tidy(ht_yc_fit_1)
```


--
- Year < Is Male < Is Heart Attack < Is Coronary Heart Disease < Is Age 75+

---
# Residual plot 

```{r out.width= "45%", fig.align="center", echo = FALSE}
ht_yc_fit_aug_1 <- augment(ht_yc_fit_1$fit)
ggplot(ht_yc_fit_aug_1, mapping = aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "gray", lty = "dashed") +
  labs(x = "Predicted CrudeRate", y = "Residuals")+
  theme(
    plot.margin = unit(c(0, 0, 0, 0), "cm"), 
  )
```

--
- Clustered residuals with a large empty gap  
Most groups have low crude mortality rates；Only specific groups (e.g., 75+ or certain diagnoses) have very high mortality. Hence,this creates natural gaps in the distribution, independent of the mode  

--
- Fan-shaped pattern  
i. Missing important predictors  
ii. Non-linear relationships that the linear model cannot capture  
iii. The limitations of simple transformations  

---
# log ( CrudeRate + 1 )

```{r echo = FALSE, results='hide'}
ht_yc_fit_2 <- linear_reg() %>%
  set_engine("lm") %>%
  fit(log(CrudeRate + 1) ~ Year+split_AgeGroup+Sex+Diagnosis ,data = Data)
tidy(ht_yc_fit_2)
```

```{r out.width= "75%", fig.align="center", echo = FALSE}
ht_yc_fit_aug_2 <- augment(ht_yc_fit_2$fit)
ggplot(ht_yc_fit_aug_2, mapping = aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "gray", lty = "dashed") +
  labs(x = "Predicted CrudeRate", y = "Residuals")
```


---

class: inverse, center, middle

# Adjusted R²


---

---
#Adjusted R²
```{r echo = FALSE}
glance(ht_yc_fit_1)$adj.r.squared
```

---
# Scatter Plot: CrudeRate vs Year

```{r echo = FALSE, results='hide'}
ht_yc_fit_3 <- linear_reg() %>%
  set_engine("lm") %>%
  fit(CrudeRate ~ Year,data = Data)
tidy(ht_yc_fit_3)
```


```{r out.width= "75%", fig.align="center", echo = FALSE}
ht_yc_fit_aug_3 <- augment(ht_yc_fit_3$fit)

ggplot(data=ht_yc_fit_aug_3 ,aes(x=Year,y=CrudeRate))+
  geom_point(alpha=0.25)+
  geom_line(aes(x = Year, y = .fitted), linewidth = 0.75)+
  geom_point(mapping = aes(x = Year,y = .fitted), color = "#E48957")+
  geom_segment(mapping = aes(x = Year, y = CrudeRate,
                             xend = Year, yend = .fitted), color = "#E48957", alpha = 0.4)+
  labs(x = "Year",
    y = "Cruderate"
  )
```

---
# Brief summary

Although the linear regression model has limitations, it successfully identifies three key factors that may influence heart disease mortality:  

i. Age group (especially 75+)  

ii. Sex (male)  

iii. Diagnosis type (Coronary Heart Disease, Heart Attack)  

---

class: inverse, center, middle

# Logistic regression model

---

# Logistic regression model

--
<span style="font-size: 1.4em; font-weight: bold;"> Aim: </span>

- To develop and evaluate a logistic regression model that predicts high/low crude-rate risk from age group, sex and diagnosis.  


--
<span style="font-size: 1.4em; font-weight: bold;"> Data: </span>

- X = Age + Sex + Diagnosis  

- Y= Rate -> 0,1 because aim to classify high/low risk  

- train / test data set (randomly 80% / 20%)  


--
<span style="font-size: 1.4em; font-weight: bold;"> Model: </span>

- GLM (Generalized Linear Model) -> model train and model test  

---

# Logistic regression model

--
```{r out.width= "75%", fig.align="center", echo = FALSE, message=FALSE}
CA <- Data %>% 
  mutate(rate = CrudeRate / 1000) %>% 
  mutate(rate_group = if_else(rate <= median(rate, na.rm = TRUE), 0, 1)) %>% 
  mutate(rate_group = factor(rate_group))

set.seed(888)
CrudeRate_split <- initial_split(CA, prop = 0.80)

train_data <- training(CrudeRate_split)
test_data  <- testing(CrudeRate_split)

CrudeRate_fit <- logistic_reg() %>%
  set_engine("glm") %>%
  fit(rate_group ~ AgeGroup + Sex + Diagnosis,
      data = train_data,
      fimily = "binomial")

CrudeRate_pred <- predict(CrudeRate_fit, test_data, type = "prob") %>%
  bind_cols(test_data)

CrudeRate_pred %>%
  roc_curve(
    truth = rate_group,
    .pred_1,
    event_level = "second"
  ) %>%
  autoplot()


CrudeRate_pred %>%
  roc_auc(
    truth = rate_group,
    .pred_1,
    event_level = "second"
  )

```
---
#AUC

--
```{r echo = FALSE}
CrudeRate_pred %>%
  roc_auc(
    truth = rate_group,
    .pred_1,
    event_level = "second"
  )
```


---
#Sensitivity and specificity

--
.pull-left[
<span style="font-size: 1.4em; font-weight: bold;">  cutoff = 0.25 </span>
- Sensitivity = 30 / ( 30 + 20 ) ≈ 0.60
- Specificity = 534 / ( 534 + 32 ) ≈ 0.943   
]
.pull-right[
```{r out.width= "75%", fig.align="center", echo = FALSE, message=FALSE}
cutoff_prob <- 0.25
CrudeRate_pred %>%
  mutate(
    rate_group      = if_else(rate_group == 1 , "high_CrudeRate", "low_CrudeRate"),
    rate_group_pred = if_else(.pred_1 > cutoff_prob, "labelled high-CrudeRate", "labelled low-CrudeRate")
  ) %>%
  count(rate_group_pred, rate_group) %>%
  pivot_wider(names_from = rate_group, values_from = n) %>%
  kable(col.names = c(" ","high_CrudeRate","low_CrudeRate"))
```
]


--
.pull-left[
<span style="font-size: 1.4em; font-weight: bold;">  cutoff = 0.5 </span>
- Sensitivity = 24 / ( 24 + 26 ) ≈ 0.48
- Specificity = 553 / ( 553 + 26 ) ≈ 0.977  
]
.pull-right[
```{r out.width= "75%", fig.align="center", echo = FALSE, message=FALSE}
cutoff_prob<-0.5
CrudeRate_pred %>%
  mutate(
    rate_group      = if_else(rate_group == 1 , "high_CrudeRate", "low_CrudeRate"),
    rate_group_pred = if_else(.pred_1 > cutoff_prob, "labelled high-CrudeRate", "labelled low-CrudeRate")
  ) %>%
  count(rate_group_pred, rate_group) %>%
  pivot_wider(names_from = rate_group, values_from = n) %>%
  kable(col.names = c(" ","high_CrudeRate","low_CrudeRate"))
```
]

--
.pull-left[
<span style="font-size: 1.4em; font-weight: bold;"> cutoff = 0.75 </span>
- Sensitivity = 9 / ( 9 + 41 ) ≈ 0.18
- Specificity = NA
]
.pull-right[
```{r out.width= "75%", fig.align="center", echo = FALSE, message=FALSE}
cutoff_prob<-0.75
CrudeRate_pred %>%
  mutate(
    rate_group      = if_else(rate_group == 1 , "high_CrudeRate", "low_CrudeRate"),
    rate_group_pred = if_else(.pred_1 > cutoff_prob, "labelled high-CrudeRate", "labelled low-CrudeRate")
  ) %>%
  count(rate_group_pred, rate_group) %>%
  pivot_wider(names_from = rate_group, values_from = n) %>%
  kable(col.names = c(" ","high_CrudeRate","low_CrudeRate"))

```
]

---

class: inverse, center, middle

# Conclusion

---

# Biases:

<span style="font-size: 1.4em; font-weight: bold;"> Gender: </span>
Heart disease may be influenced by behaviors such as smoking rate and alcohol consumption.
The model may attribute these hidden effects to gender itself, thus exaggerating gender differences.

<span style="font-size: 1.4em; font-weight: bold;"> Time: </span>
Certain infectious diseases in some years, such as COVID-19, may also cause abnormal mortality rates.

<span style="font-size: 1.4em; font-weight: bold;"> Dataset selection: </span>
A single dataset may be affected by multiple factors (such as collection methods), leading to unrealistic results

(for example: many regions have a mortality rate of 0).

---
<span style="font-size: 1.4em; font-weight: bold;"> Limitations: </span>

Insufficient explanatory variables:  
The data lacks important factors such as health behaviors, lifestyle, and economic conditions,which makes the model unable to properly explain the differences in mortality rate.

The threshold for risk classification may affect results:  
Different thresholds may produce different conclusions.

Structural gaps in the data itself:   
The distribution between high-mortality and low-mortality groups is very unbalanced,causing clustering patterns in the residual plot

<span style="font-size: 1.4em; font-weight: bold;"> Future Improvements: </span>

Data selection:
- Add more explanatory variables (such as regional economic level, disease behavior risk, hospital resources)
- Expand the sample range (e.g.include longer time span)
Data processing:
-	linear regression model--Try more complex transformations
-	Logistic regression model--Optimize the high/low risk classification method (e.g.quartile)
-	Control the influence of external events (e.g., stratify by COVID years before analysis)