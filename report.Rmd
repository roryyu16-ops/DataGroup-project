---
title: "IDS Project"
author: "by Artery Party: Roderick Yu, Yufei Xiang, Hoddy Zhu, Lincoln Luk"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, include = FALSE}

library(tidyverse)
library(tidymodels)
library(knitr)
library(kableExtra)

```


```{r load-data, include=FALSE}

MArea <- read_csv("data/HDM_CouncilArea.csv")



Data<- MArea %>%
  select(Year,CA,AgeGroup,Sex,Diagnosis,CrudeRate,EASR) %>%
  drop_na()


```


## Research Question

Our main research question is to explore how heart disease mortality varies across Scotland and across demographic categories such as gender, geographical area, age group, and year. The aim is to identify long-term patterns and determine whether certain groups consistently show higher mortality. We also use modelling to generate risk predictions for the Scottish population.

This dataset interested us because heart disease could affect anyone and is a leading cause of death, making it important to understand which groups are most at risk.

## Data Overview

We used the Heart Disease Mortality by Council Area dataset from Public Health Scotland. The raw dataset contains 17,820 observations and 14 variables. To focus on demographic and mortality-related information, we selected seven key variables, resulting in a cleaned dataset of 7,230 observations.

```{r, echo = FALSE}
overview <- tribble(
  ~Variable,       ~Description,                                  ~Type,
  "Year",          "Year of recorded data",                       "Numeric",
  "CA",            "Council area code",                           "Categorical",
  "AgeGroup",      "Defined age range",                           "Categorical",
  "Sex",           "Male or female",                              "Categorical",
  "Diagnosis",     "Specific heart-disease-related diagnosis",    "Categorical",
  "CrudeRate",     "Raw mortality rate",                          "Numeric",
  "EASR",          "European Age-Standardised Rate",              "Numeric"
)

overview %>%
  kable(head(overview), format = ("html")) %>% 
  kable_styling(full_width = FALSE, position = "left")
```

## Exploratory Statistics

We began by categorising our data into subgroups, grouping age groups, sex and diagnosis into smaller groups. We then matched each subgroup with their mean crude rates to see how they differ.

```{r, echo = FALSE}
Data %>%
  group_by(AgeGroup) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE),
            median_cruderate = median(CrudeRate , na.rm = TRUE)) 

Data %>%
  group_by(Sex) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE),
              median_cruderate = median(CrudeRate , na.rm = TRUE)) 

Data %>%  
  group_by(Diagnosis) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE),
              median_cruderate = median(CrudeRate , na.rm = TRUE)) 
```

These summary statistics show that age is the strongest factor, with the largest differences in mean and median crude rates. Rates for those under 75 are much lower than for older groups.

Sex differences are also clear: men have noticeably higher mortality rates than women. Among diagnoses, coronary heart disease has the highest rates, followed by heart attacks, with heart failure lowest.

## Data Visualisations

To understand more about this dataset, we tried to find more patterns by making visualisations.

### 1. EASR

Firstly, we compared the EASR and crude rate in this dataset. The EASR is the European Age-Sex standardised rate per 100,000 population. It is adjusted for the age distribution using a standard population (100,000) and provides a more valid and unbiased comparison than crude rate.

```{r,echo=FALSE, message= FALSE}
# Chart of EASR

ggplot(data = Data,
       mapping = aes(x = EASR, 
                     y = CrudeRate, 
                     )) +
  geom_point(size = 1)+
  geom_smooth(method = lm , se = FALSE)
```

The EASR–crude rate plot shows a near-perfect correlation (gradient 1), confirming that crude rate is reliable and suitable for the rest of the analysis.


### 2. Geographical area

To start off, we tried to find if there were differences in mortality rate for each region of Scotland.

```{r, echo = FALSE, warning= FALSE}
#Chart of Area

CA_Regions <- Data %>% 
  filter(!CA %in% c("S92000003")) %>%
  mutate(
    Region = case_when(
      CA %in% c("S12000033", "S12000034", "S12000020", "S12000017") ~ "North",
      CA %in% c("S12000038", "S12000039", "S12000015","S12000047") ~ "North East",
      CA %in% c("S12000005", "S12000014", "S12000026", "S12000036", "S12000042", "S12000044","S12000048") ~ "Central",
      CA %in% c("S12000006", "S12000010", "S12000019", "S12000028", "S12000045") ~ "South",
      CA %in% c("S12000008", "S12000009", "S12000011", "S12000018", "S12000021", "S12000023", "S12000027", "S12000030", "S12000035", "S12000040", "S12000041","S12000013","S12000029","S12000049","S12000050") ~ "West",
      TRUE ~ "Others"
      )
  )


CA_summary <- CA_Regions %>%
  group_by(Region) %>%
  summarise(
    mean_rate  = mean(CrudeRate, na.rm = TRUE)
  )


  ggplot(CA_summary, aes(x = Region, y = mean_rate)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Crude Mortality Rate by Council Area",
    x = "Region",
    y = "Mean Crude Mortality Rate"
  )
```

After assigning each council area to a region, we compared mean crude rates across regions. Mortality levels were largely similar across Scotland, with the North-East showing only a small increase (around 5%). Since these differences were minimal, geographical region was not considered an important factor and was excluded from modelling.

### 3. Sex 

Then, we made a bar chart with the mean value of crude rates across all men and women. 

```{r, echo = FALSE, warning= FALSE}
# Bar chart of Sex
table_sex<-Data %>% 
  filter(!Sex %in% c("All"))%>%
  group_by(Sex) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(table_sex)+
       geom_bar(mapping= aes (x=Sex,
                     y=mean_cruderate,
                     fill=Sex),
                     stat = "identity")+
  labs(title = "The mean value of cruderate for different Sexs",
       x="Sex",
       y="Mean Cruderate",
       fill="Sex")
```

A bar chart comparing male and female mortality showed that men have nearly double the crude rate of women, making sex an influential variable. This aligns with biological and lifestyle-based explanations consistently found in cardiovascular research.

### 4. Age

We then investigated the different age groups differed in crude rate. 

```{r, echo = FALSE, warning= FALSE}
#Bar chart of Age
table_age<-Data %>%
  filter(!AgeGroup %in% c("All"))%>%
  group_by(AgeGroup) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(table_age)+
       geom_bar(mapping= aes (x=AgeGroup,
                              y=mean_cruderate,
                              fill=AgeGroup),
                              stat = "identity")+
  labs(title = "The mean value of cruderate for different AgeGroups",
       x="Age",
       y="Mean Cruderate",
       fill="AgeGroup")
```

Age differences were clear: the 75+ group had dramatically higher crude rates than all younger groups. This confirms age as the dominant factor in heart disease mortality.


### 5. Year

We then compared mean crude rate with year, visualising it with a line chart. 

```{r, echo = FALSE, warning= FALSE}
#line chart of year
summary_diagnosis <- Data%>%
  group_by(Year) %>%
   summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(summary_diagnosis, aes(x = Year, y = mean_cruderate)) +
  geom_line(size = 1) +
  geom_point() +
  labs(
    title = "The mean value of cruderate over Years",
    x = "Year",
    y = "Mean Cruderate"
  ) +
  theme_minimal()
```

Crude rates declined gradually and then rose again toward 2019. However, the pattern does not indicate a strong linear trend, suggesting that year alone is not a meaningful predictor of mortality.

### 6. Diagnosis

Finally, for the single variables, we looked at the diagnoses and how crude rate differed between the three. 

``` {r, echo = FALSE, warning= FALSE}
# Bar chart of Diagnosis
table_Diagnosis<-Data %>%
  group_by(Diagnosis) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(table_Diagnosis)+
       geom_bar(mapping= aes (x=Diagnosis,
                     y=mean_cruderate,
                     fill=Diagnosis),
                     stat = "identity")+
  labs(title = "The mean value of cruderate for different Diagnosis",
       x="Diagnosis",
       y="Mean Cruderate",
       fill="Diagnosis")
```

This visualisation does not tell us much, but we can clearly see the distribution of deaths among the three diagnoses, with coronary heart diseases with the highest rate, followed by heart attacks, and heart failure with the lowest rate. 

### 7. Combining variables 

After investigating each variable individually against the mean crude rate, we figured that each variable did not tell us much on its own. So, we combined variables together, comparing two variables together with crude rate.

We first compared year with age and diagnosis.

```{r, echo = FALSE, message= FALSE}
#Table 7(Age and Year)
 Table_5<-Data %>%
    group_by(AgeGroup,Year) %>%
    filter(!AgeGroup %in% c("All"))%>%
    summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE)) 
  ggplot(Table_5, aes(x = Year, y = mean_cruderate, color =AgeGroup , group = AgeGroup)) +
    geom_line(size = 1) +
    geom_point() +
    labs(
      title = "Mean crude rate by AgeGroup over Years",
      x = "Year",
      y = "Mean crude rate"
    ) +
    theme_minimal()
```

```{r, echo = FALSE, message= FALSE}
#Table 8(Diagnosis and year)
summary_diagnosis <- Data %>%
group_by(Year, Diagnosis) %>%
summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(summary_diagnosis,aes(x = Year, y = mean_cruderate, color = Diagnosis, group = Diagnosis)) +
  geom_line(size = 1) +
  geom_point() +
  labs(
    title = "Mean crude rate by Diagnosis over Years",
    x = "Year",
    y = "Mean crude rate"
  ) +
  theme_minimal()
```

The overall shape changed compared to the original year curve, showing there is variation between these factors. We decided to use modelling to further determine year's significance in our investigation.


We then compared diagnosis with age and sex.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
#Table 9 (Agegroup and Diagnosis)
table_1<- Data %>%
  filter(!AgeGroup %in% c("All"))%>%
  group_by(AgeGroup,Diagnosis) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))

ggplot(table_1, aes(x = Diagnosis, y = mean_cruderate, fill = AgeGroup)) +
  geom_col(position = position_dodge(width = 0.8)) +
  labs(
    title = "Mean crude rate by heart-disease type and Agegroup",
    x = "Heart-disease type",
    y = "Mean crude rate",
    fill = "AgeGroup"
  )
```

```{r, echo = FALSE, message= FALSE}
#Table 10 (Sex and Diagnosis)
Table_2<-Data %>%
  filter(!Sex %in% c("All"))%>%
  group_by(Sex,Diagnosis) %>%
  summarise(mean_cruderate = mean(CrudeRate , na.rm = TRUE))
ggplot(Table_2, aes(x = Diagnosis, y = mean_cruderate, fill = Sex)) +
  geom_col(position = position_dodge(width = 0.8)) +
  labs(
    title = "Mean crude rate by heart-disease type and sex",
    x = "Heart-disease type",
    y = "Mean crude rate",
    fill = "Sex"
  )
```

To understand interactions between variables, we visualised combinations such as age x year and diagnosis x sex. These combined plots were consistent with the earlier findings, confirming that age, sex, and diagnosis meaningfully influence mortality, while year contributes little.

This gave confidence in selecting variables for modelling.

## Predictive Modelling

### Data Processing

After excluding aggregated categories such as “All” in age and sex, 3068 valid observations remained for modelling. Age was grouped into two categories (“Under 75” and “75+”) to simplify interpretation and stabilise model estimates. Reference levels were set for age, sex, and diagnosis to allow meaningful comparisons.

```{r}
Data<-Data%>% 
  filter(!Sex %in% c("All"))%>%
  filter(!AgeGroup %in% c("All"))
```

Grouping

```{r}
Data <- Data %>%
  mutate(
    split_AgeGroup = case_when(
      AgeGroup %in% c("75plus years") ~ "75plus years",
      AgeGroup %in% c("0-44 years", "45-64 years", "65-74 years", "under75 years") ~ "under75 years",
      TRUE ~ "Others"
      )
  )


Data$split_AgeGroup<-relevel(factor(Data$split_AgeGroup),ref="under75 years")
Data$Diagnosis<-relevel(factor(Data$Diagnosis),ref="Heart Failure")
Data$Sex<-relevel(factor(Data$Sex),ref="Females")
```

### Coefficient Interpretation

```{r}
ht_yc_fit_1 <- linear_reg() %>%
  set_engine("lm") %>%
  fit(CrudeRate ~ Year+split_AgeGroup+Sex+Diagnosis ,data = Data)
tidy(ht_yc_fit_1)
```

```{r}
coef_summary <- tribble(
  ~Variable, ~Interpretation,
  "Year", "Extremely small coefficient — time has minimal or no linear effect on crude mortality rate.",
  "AgeGroup", "The 75+ age group has the largest coefficient, making age the strongest predictor of crude mortality rate.",
  "Sex", "Males have a positive and significant coefficient, showing higher mortality rates than females.",
  "Diagnosis", "Coronary Heart Disease and Heart Attack have large coefficients, indicating strong contributions to mortality."
)

coef_summary %>%
  kable(format = "html", caption = "Interpretation of Model Coefficients") %>%
  kable_styling(full_width = FALSE, position = "left")
```

#### Importance Ranking (from least to most influential):
Year < Is Male < Is Heart Attack < Is Coronary Heart Disease < Is Age 75+

### Residual Plot Analysis
```{r}

ht_yc_fit_aug_1 <- augment(ht_yc_fit_1$fit)
ggplot(ht_yc_fit_aug_1, mapping = aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "gray", lty = "dashed") +
  labs(x = "Predicted CrudeRate", y = "Residuals")


```

The residual plot shows several important patterns:

#### 1. Clustered residuals with a large empty gap

Residuals cluster at low and high fitted values, with very few in the 100–200 range.
This reflects the natural separation between low-risk groups (younger ages, heart failure) and high-risk groups (75+, CHD).

#### 2. Fan-shaped pattern 

Residuals spread out more at higher fitted values.

This may be due to:
- Missing behavioural or socioeconomic predictors
- Non-linear relationships
- Limitations of linear modelling

Even log-transforming crude rate did not resolve these issues.

```{r results = "hide"}
ht_yc_fit_2 <- linear_reg() %>%
  set_engine("lm") %>%
  fit(log(CrudeRate+1) ~ Year+split_AgeGroup+Sex+Diagnosis ,data = Data)
tidy(ht_yc_fit_2)
```


```{r results = "hide"}
ht_yc_fit_aug_2 <- augment(ht_yc_fit_2$fit)
ggplot(ht_yc_fit_aug_2, mapping = aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "gray", lty = "dashed") +
  labs(x = "Predicted CrudeRate", y = "Residuals")
```

### Adjusted R²

The adjusted R² shows that the linear model explains only a modest portion of the variability in crude mortality. This reflects both the skewed data distribution and the limited number of available predictors.

```{r}
glance(ht_yc_fit_1)$adj.r.squared
```

### Scatter Plot: CrudeRate vs Year

To further investigate the negligible effect of time, we plotted CrudeRate against Year.

The scatter plot shows:
- Clear vertical stacking of values
- No visible linear relationship between Year and CrudeRate
- Mortality rates remain stable across years

These patterns confirm that Year is not a meaningful predictor in this dataset.

```{r results = "hide"}
ht_yc_fit_3 <- linear_reg() %>%
  set_engine("lm") %>%
  fit(CrudeRate ~ Year,data = Data)
tidy(ht_yc_fit_3)
```


```{r}
ht_yc_fit_aug_3 <- augment(ht_yc_fit_3$fit)

ggplot(data=ht_yc_fit_aug_3 ,aes(x=Year,y=CrudeRate))+
  geom_point(alpha=0.25)+
  geom_line(aes(x = Year, y = .fitted), linewidth = 0.75)+
  geom_point(mapping = aes(x = Year,y = .fitted), color = "#E48957")+
  geom_segment(mapping = aes(x = Year, y = CrudeRate,
                             xend = Year, yend = .fitted), color = "#E48957", alpha = 0.4)+
  labs(title = "Year vs CrudeRate",
    x = "Year",
    y = "Cruderate"
  ) 

```

### Brief summary

Although the linear regression model has limitations, it successfully identifies three key factors that may influence heart disease mortality:

1. Age group (especially 75+)
2. Sex (male)
3. Diagnosis type (Coronary Heart Disease, Heart Attack)


## Logistic regression model

We built a binary classification model to predict whether an observation fell into a high- or low-risk cardiovascular mortality group. The crude mortality rate was scaled and then split at the median to form the two classes. Age, sex, and diagnosis were used as predictors, and the data was split into an 80% training set and a 20% test set for model evaluation.

```{r}
CA <- Data %>% 
  mutate(rate = CrudeRate / 1000) %>% 
  mutate(rate_group = if_else(rate <= median(rate, na.rm = TRUE), 0, 1)) %>% 
  mutate(rate_group = factor(rate_group))

set.seed(888)
CrudeRate_split <- initial_split(CA, prop = 0.80)

train_data <- training(CrudeRate_split)
test_data  <- testing(CrudeRate_split)

CrudeRate_fit <- logistic_reg() %>%
  set_engine("glm") %>%
  fit(rate_group ~ AgeGroup + Sex + Diagnosis,
      data = train_data,
      fimily = "binomial")

CrudeRate_pred <- predict(CrudeRate_fit, test_data, type = "prob") %>%
  bind_cols(test_data)

AUC_ROC <- CrudeRate_pred %>%
  roc_curve(
    truth = rate_group,
    .pred_1,
    event_level = "second"
  )
  
AUC_ROC %>% autoplot()
```

ROC curve  
 - X-axis: false-positive rate (FPR), the proportion of true low-risk individuals incorrectly classified as high-risk.  
 - Y-axis: true-positive rate (TPR), the proportion of true high-risk individuals correctly identified.

 The curve bows toward the upper-left corner, indicating good discriminatory performance.

```{r}
cutoff_prob<-0.25
CrudeRate_pred %>%
  mutate(
    rate_group      = if_else(rate_group == 1 , "high_CrudeRate", "low_CrudeRate"),
    rate_group_pred = if_else(.pred_1 > cutoff_prob, "labelled high-CrudeRate", "labelled low-CrudeRate")
  ) %>%
  count(rate_group_pred, rate_group) %>%
  pivot_wider(names_from = rate_group, values_from = n) %>%
  kable(col.names = c(" ","high_CrudeRate","low_CrudeRate"))
```
- Sensitivity = 30 / ( 30 + 20 ) ≈ 0.60
- Specificity = 534 / ( 534 + 32 ) ≈ 0.943 

```{r}
cutoff_prob<-0.5
CrudeRate_pred %>%
  mutate(
    rate_group      = if_else(rate_group == 1 , "high_CrudeRate", "low_CrudeRate"),
    rate_group_pred = if_else(.pred_1 > cutoff_prob, "labelled high-CrudeRate", "labelled low-CrudeRate")
  ) %>%
  count(rate_group_pred, rate_group) %>%
  pivot_wider(names_from = rate_group, values_from = n) %>%
  kable(col.names = c(" ","high_CrudeRate","low_CrudeRate"))
```
- Sensitivity = 24 / ( 24 + 26 ) ≈ 0.48
- Specificity = 553 / ( 553 + 26 ) ≈ 0.977  

```{r}
cutoff_prob<-0.75
CrudeRate_pred %>%
  mutate(
    rate_group      = if_else(rate_group == 1 , "high_CrudeRate", "low_CrudeRate"),
    rate_group_pred = if_else(.pred_1 > cutoff_prob, "labelled high-CrudeRate", "labelled low-CrudeRate")
  ) %>%
  count(rate_group_pred, rate_group) %>%
  pivot_wider(names_from = rate_group, values_from = n) %>%
  kable(col.names = c(" ","high_CrudeRate","low_CrudeRate"))
```
- Sensitivity = 9 / ( 9 + 41 ) ≈ 0.18
- Specificity = NA

The ROC curve shows strong model performance, with the curve bending toward the upper-left corner. We tested thresholds of 0.25, 0.50, and 0.75. Increasing the cut-off from 0.25 to 0.50 reduced sensitivity (0.60 -> 0.48) but only slightly improved specificity (0.943 -> 0.977).

Because detecting high-risk cases is the priority, we selected 0.25 as the preferred threshold. At this level, the model identifies 60% of high-risk observations while maintaining high specificity (0.943). Although this increases false positives slightly, it avoids missing many genuinely high-risk individuals. Future work could aim to improve sensitivity without losing specificity.


```{r}
CrudeRate_pred %>%
  roc_auc(
    truth = rate_group,
    .pred_1,
    event_level = "second"
  )
```

The area under the ROC curve (AUC) is 0.842. A higher AUC indicates better performance, so this value confirms that the model is of good quality.

Overall, the logistic model performs well despite using only three predictors, suggesting that even minimal information can meaningfully classify cardiovascular risk.

### Limitations

Insufficient explanatory variables:
The dataset lacks key factors such as lifestyle, health behaviours, and socioeconomic conditions, limiting the model’s ability to fully explain differences in mortality rates.

Threshold sensitivity:
Different probability cut-offs can change the model’s classification results, affecting sensitivity and specificity.

Imbalanced data structure:
High- and low-mortality groups are unevenly distributed, leading to clustering patterns in the residuals and reducing model stability.

### Future Improvements

Data selection:
- Include additional variables (e.g., socioeconomic factors, risk behaviours, healthcare access).
- Expand the dataset, such as using a longer time span.

Data processing:
- Test more flexible transformations for the linear model.
- Improve the high/low risk classification method in the logistic model (e.g., use quartiles).
- Account for external factors like COVID-19 by analysing affected years separately.


## Conclusion

This project shows that age (especially 75+), sex, and diagnosis type are the most influential factors in heart disease mortality in Scotland. Geography and year contribute very little explanatory power. The linear model highlighted these relationships, while the logistic model achieved strong predictive accuracy (AUC = 0.842). Although the dataset lacks behavioural and socioeconomic variables, the findings provide a solid foundation for understanding population-level risk and highlight opportunities for improved modelling in future research.


## References

Public Health Scotland (NHS Scotland, 2024) -- Scottish Heart Disease Statistics -- Heart Disease Mortality by Council Area
https://www.opendata.nhs.scot/dataset/scottish-heart-disease-statistics/resource/fc7b42f1-4de6-48dd-b640-613fb0aa427d
accessed (17/10/2025)

Public Health Scotland (NHS Scotland, 2020) -- Council Area 2011 - Council Area 2019 
https://www.opendata.nhs.scot/dataset/geography-codes-and-labels/resource/967937c4-8d67-4f39-974f-fd58c4acfda5
accessed (7/11/2025)
